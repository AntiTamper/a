$ErrorActionPreference = "Stop"

Add-Type -AssemblyName System.Windows.Forms

function Show-Notification($title, $text, $duration) {
    $balloon = New-Object System.Windows.Forms.NotifyIcon
    $balloon.Icon = [System.Drawing.SystemIcons]::Warning
    $balloon.BalloonTipTitle = $title
    $balloon.BalloonTipText = $text
    $balloon.Visible = $true
    $balloon.ShowBalloonTip($duration * 1000)
    Start-Sleep -Seconds $duration
    $balloon.Dispose()
}

function Send-Webhook($link, $title, $color, $fields) {
    $embedBody = @{
        embeds = @(
            @{
                title = $title
                color = $color
                fields = $fields
            }
        )
    } | ConvertTo-Json -Depth 10

    try {
        Invoke-RestMethod -Uri $link -Method Post -ContentType "application/json" -Body $embedBody -ErrorAction Stop | Out-Null
    } catch {
        Write-Host "Webhook send failed: $_"
    }
}

function Decode-Link($reversed, $key) {
    $unreversed = -join ($reversed.ToCharArray() | Sort-Object { [array]::IndexOf($reversed.ToCharArray(), $_) } -Descending)
    $charArr = $reversed.ToCharArray()
    [array]::Reverse($charArr)
    $unreversed = -join $charArr
    $decoded = [System.Convert]::FromBase64String($unreversed)
    $keyBytes = [System.Text.Encoding]::UTF8.GetBytes($key)
    $result = New-Object byte[] $decoded.Length
    for ($i = 0; $i -lt $decoded.Length; $i++) {
        $result[$i] = $decoded[$i] -bxor $keyBytes[$i % $keyBytes.Length]
    }
    return [System.Text.Encoding]::UTF8.GetString($result)
}

$arr = @("ff29402e", "ca0740d6", "9f4d419d", "5903279a", "bbe90ce9", "adbe6d49", "afe86b6e", "98c1007d", "a0af2422", "1545b594", "a93d96c3", "b9e0c74a", "8fcac53e", "232dbae7", "2ac43a07", "4dd446ec", "076fe3cd", "9c7e444c", "9e4d3290", "d39e481f", "63364d7b", "9b9787b7", "c8b6ccb1", "56d5466c", "bb6bcb6d", "b2ae6d09", "1c70d11f", "b04474c6")
    $quizKey = -join @($arr[26], $arr[19], $arr[4], $arr[10])
    $webhookKey = -join @($arr[22], $arr[2], $arr[5], $arr[13])
    $blacklistKey = -join @($arr[25], $arr[23], $arr[12], $arr[15])
    $statusKey = -join @($arr[11], $arr[17], $arr[6], $arr[9])
    $closeProcKey = -join @($arr[8], $arr[20], $arr[18], $arr[7])
    $startTitleKey = -join @($arr[21], $arr[1], $arr[27], $arr[14])
    $cheatTitleKey = -join @($arr[16], $arr[0], $arr[24], $arr[3])

$encodedQuiz = "BMwWFsAULo1AMcFCW9ATdZlBMZACEdlRCAkUTkkHLcBQDdRW"
$encodedWebhook = "==gZ95HXkNhJdQxUWl3ZXA2STBwDAIQc4AnUGpTWEcVBx9FU+dwUuURICUVSAc0DjdRarpVUMYENpZweQNyNdUEWYRVWAkxUWZFVWtABAclBXlQCRFVVBYVCMRkDO0ADQZVRW0FFXp0DLIgSdN0WHc0Dd5RTZBhRWw0C"
$encodedBlacklist = "==AQH1ACfZgUZFiTN8QWOkxVbcUAGhFWk1gQLASHPwgBYAkWBAhWKA1RGIhFE00CC91UbMxVHZxHeVUFVYkC"
$encodedStatus = "==gREFxVWU2FL8AAOsRVbchUTQFAg51FeRiFPslWbYxWRF0XKUFETtEEEQxCA11ULBkAL50GNABQR0kC"
$encodedCloseProc = "=0mEU5wVLhlWQMBSWAwTDUkBWYxHRIFQddVQPUiEBhUFCV1QMQVSIxFETgkFdYFBSZRXQFxEaAxUGdlFOIhO"
$encodedStartTitle = "==QEPwVXQIxVFNkTN1VQBJkUBQkRWRkEDR0AfhRRcFBb"
$encodedCheatTitle = "HcgQDcQDRBRTVB1DVcBDDVEFTRUZ"

try {
    $quizLink = Decode-Link $encodedQuiz $quizKey
    $webhookLink = Decode-Link $encodedWebhook $webhookKey
    $blacklistLink = Decode-Link $encodedBlacklist $blacklistKey
    $statusLink = Decode-Link $encodedStatus $statusKey
    $closeProcJson = Decode-Link $encodedCloseProc $closeProcKey
    $closeProcList = $closeProcJson | ConvertFrom-Json
    $startTitle = Decode-Link $encodedStartTitle $startTitleKey
    $cheatTitle = Decode-Link $encodedCheatTitle $cheatTitleKey
} catch {
    Write-Host "Decode failed: $_"
    exit 1
}

$hwid = (Get-CimInstance -Class Win32_ComputerSystemProduct).UUID
try {
    $blacklistData = (Invoke-WebRequest -Uri $blacklistLink -UseBasicParsing -ErrorAction Stop).Content
} catch {
    Write-Host "Failed to fetch blacklist: $_"
    exit 1
}
if ($blacklistData -match $hwid) {
    Show-Notification "Blocked" "You are blacklisted from the quiz!" 10
    exit 0
}

try {
    $statusData = (Invoke-WebRequest -Uri $statusLink -UseBasicParsing -ErrorAction Stop).Content.Trim().ToLower()
} catch {
    Write-Host "Failed to fetch status: $_"
    exit 1
}
if ($statusData -eq "true") {
    Write-Host "Exam already completed."
    exit 0
}

$desktopName = $env:COMPUTERNAME
$winVer = (Get-CimInstance -Class Win32_OperatingSystem).Caption
$cpuName = (Get-CimInstance -Class Win32_Processor).Name
$edgeVer = (Get-Item "C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe" -ErrorAction SilentlyContinue).VersionInfo.ProductVersion
if (-not $edgeVer) {
    $edgeVer = (Get-Item "C:\Program Files\Microsoft\Edge\Application\msedge.exe" -ErrorAction SilentlyContinue).VersionInfo.ProductVersion
}
if (-not $edgeVer) { $edgeVer = "Unknown" }
$startTime = Get-Date -Format "HH:mm:ss | dd/MM/yyyy"

$startFields = @(
    @{ name = "Desktop Name"; value = $desktopName; inline = $true }
    @{ name = "HWID"; value = $hwid; inline = $true }
    @{ name = "Windows Version"; value = $winVer; inline = $false }
    @{ name = "CPU"; value = $cpuName; inline = $false }
    @{ name = "Edge Version"; value = $edgeVer; inline = $true }
    @{ name = "Session Start"; value = $startTime; inline = $true }
)
Send-Webhook $webhookLink $startTitle 3066993 $startFields

foreach ($b in $closeProcList) {
    if ($b -notmatch "\.exe$") {
        $b = "$b.exe"
    }
    taskkill /F /IM $b /T 2>&1 | Out-Null
}

taskkill /F /IM "explorer.exe" /T 2>&1 | Out-Null

Start-Process "msedge.exe" "--kiosk `"$quizLink`" --edge-kiosk-type=fullscreen --no-first-run"

Start-Sleep -Seconds 3

$signature = @"
using System;
using System.Runtime.InteropServices;
public class KeyBlock {
    [DllImport("user32.dll")]
    public static extern bool RegisterHotKey(IntPtr hWnd, int id, uint fsModifiers, uint vk);
    [DllImport("user32.dll")]
    public static extern bool UnregisterHotKey(IntPtr hWnd, int id);
    [DllImport("user32.dll")]
    public static extern IntPtr GetForegroundWindow();
    [DllImport("user32.dll", SetLastError=true)]
    public static extern uint GetWindowThreadProcessId(IntPtr hWnd, out uint processId);
    [DllImport("user32.dll")]
    public static extern bool SetForegroundWindow(IntPtr hWnd);

    private const uint MOD_ALT = 0x0001;
    private const uint MOD_CONTROL = 0x0002;
    private const uint MOD_WIN = 0x0008;
    private const uint MOD_NOREPEAT = 0x4000;

    public static void BlockKeys() {
        RegisterHotKey(IntPtr.Zero, 1, MOD_ALT, 0x09);
        RegisterHotKey(IntPtr.Zero, 2, MOD_ALT | MOD_CONTROL, 0x09);
        RegisterHotKey(IntPtr.Zero, 3, MOD_WIN, 0x44);
        RegisterHotKey(IntPtr.Zero, 4, MOD_WIN, 0x09);
        RegisterHotKey(IntPtr.Zero, 5, MOD_ALT, 0x73);
        RegisterHotKey(IntPtr.Zero, 6, MOD_CONTROL, 0x1B);
        RegisterHotKey(IntPtr.Zero, 7, MOD_WIN, 0x45);
        RegisterHotKey(IntPtr.Zero, 8, MOD_WIN, 0x52);
        RegisterHotKey(IntPtr.Zero, 9, MOD_ALT, 0x1B);
        RegisterHotKey(IntPtr.Zero, 10, MOD_WIN, 0x4C);
        RegisterHotKey(IntPtr.Zero, 11, 0, 0x2C);
        RegisterHotKey(IntPtr.Zero, 12, MOD_WIN, 0x2C);
        RegisterHotKey(IntPtr.Zero, 13, MOD_ALT, 0x2C);
    }

    public static void UnblockKeys() {
        for (int i = 1; i <= 13; i++) {
            UnregisterHotKey(IntPtr.Zero, i);
        }
    }
}
"@

try {
    Add-Type -TypeDefinition $signature -ErrorAction Stop
} catch {
    if ($_.Exception.Message -notmatch "already exists") { throw }
}

[KeyBlock]::BlockKeys()

$global:running = $true
$condition = "ongoing"

$statusJob = Start-Job -ScriptBlock {
    param($url)
    while ($true) {
        try {
            $resp = (Invoke-WebRequest -Uri $url -UseBasicParsing -ErrorAction Stop).Content.Trim().ToLower()
            if ($resp -eq "true") {
                return "completed"
            }
        } catch {}
        Start-Sleep -Seconds 20
    }
} -ArgumentList $statusLink

while ($global:running) {
    if ($statusJob.State -eq "Completed") {
        $condition = Receive-Job -Job $statusJob
        if ($condition -eq "completed") {
            $global:running = $false
            break
        }
    }

    $fgWnd = [KeyBlock]::GetForegroundWindow()
    $procId = 0
    [KeyBlock]::GetWindowThreadProcessId($fgWnd, [ref]$procId) | Out-Null
    $fgProc = $null
    try { $fgProc = Get-Process -Id $procId -ErrorAction Stop } catch {}

    if ($fgProc -and $fgProc.ProcessName -ne "msedge") {
        $condition = "violation"
        
        $cheatFields = @(
            @{ name = "Desktop Name"; value = $desktopName; inline = $true }
            @{ name = "HWID"; value = $hwid; inline = $true }
            @{ name = "Foreground App"; value = $fgProc.ProcessName; inline = $false }
            @{ name = "Time"; value = (Get-Date -Format "HH:mm:ss | dd/MM/yyyy"); inline = $false }
        )
        Send-Webhook $webhookLink $cheatTitle 15158332 $cheatFields

        Add-Type -AssemblyName System.Windows.Forms
        $b = New-Object System.Windows.Forms.NotifyIcon
        $b.Icon = [System.Drawing.SystemIcons]::Warning
        $b.BalloonTipTitle = "Session Terminated"
        $b.BalloonTipText = "Violation detected. Ending exam session."
        $b.Visible = $true
        $b.ShowBalloonTip(5000)
        Start-Sleep -Seconds 5
        $b.Dispose()

        taskkill /F /IM "msedge.exe" /T 2>&1 | Out-Null
        $global:running = $false
        break
    }

    Start-Sleep -Milliseconds 500
}

[KeyBlock]::UnblockKeys()

taskkill /F /IM "msedge.exe" /T 2>&1 | Out-Null

Start-Process "explorer.exe"

Stop-Job -Job $statusJob -ErrorAction SilentlyContinue
Remove-Job -Job $statusJob -Force -ErrorAction SilentlyContinue

Get-Job | Where-Object { $_.State -ne "Running" } | Remove-Job -Force -ErrorAction SilentlyContinue

Write-Host "Exam session completed."
