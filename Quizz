$ErrorActionPreference = "Stop"

Add-Type -AssemblyName System.Windows.Forms

function Show-Notification($title, $text, $duration) {
    $balloon = New-Object System.Windows.Forms.NotifyIcon
    $balloon.Icon = [System.Drawing.SystemIcons]::Warning
    $balloon.BalloonTipTitle = $title
    $balloon.BalloonTipText = $text
    $balloon.Visible = $true
    $balloon.ShowBalloonTip($duration * 1000)
    Start-Sleep -Seconds $duration
    $balloon.Dispose()
}

function Decode-Link($reversed, $keyParts) {
    $key = -join $keyParts
    $unreversed = -join ($reversed.ToCharArray() | Sort-Object { [array]::IndexOf($reversed.ToCharArray(), $_) } -Descending)
    $charArr = $reversed.ToCharArray()
    [array]::Reverse($charArr)
    $unreversed = -join $charArr
    $decoded = [System.Convert]::FromBase64String($unreversed)
    $keyBytes = [System.Text.Encoding]::UTF8.GetBytes($key)
    $result = New-Object byte[] $decoded.Length
    for ($i = 0; $i -lt $decoded.Length; $i++) {
        $result[$i] = $decoded[$i] -bxor $keyBytes[$i % $keyBytes.Length]
    }
    return [System.Text.Encoding]::UTF8.GetString($result)
}

$keyParts = @("5a20", "0533", "971c", "4d13", "b2ce", "616a", "76e4", "5742")

$encodedQuiz = "BYQWBowBKY1UahlXOwlHbpAAcYQXEtgREgkVOxBHPMEQGVRX"
$encodedWebhook = "==wYlwXCkNxJLdBBexyZQUmGTJgXWF1dolCBDt2DTdgU0pFC8J1UuQxdBIQQVdECmZUaptwBfBEZwAlfBUHYNJRXdxwWVlxUXBwVBMQUAA1AGkwCAcgBHYAUaE0XYpFXHMFQO9VQXpkDdFQHVZxWAIkXdxBHPMEQGVRX"
$encodedBlacklist = "==QQHxgWcJwVdRnSNs1Ae5RBbEBVHRlUnxFReNnTY11VZEkWAIUWOU1QTZhFQdxWF1wUNZkVLxBHPMEQGVRX"
$encodedStatus = "==QRCVxVFVmSNs1Ae5RBbEBVHRlUnxFReNnTY11VZEkWAIUWOU1QTZhFQdxWF1wUNZkVLxBHPMEQGVRX"

try {
    $quizLink = Decode-Link $encodedQuiz $keyParts
    $webhookLink = Decode-Link $encodedWebhook $keyParts
    $blacklistLink = Decode-Link $encodedBlacklist $keyParts
    $statusLink = Decode-Link $encodedStatus $keyParts
} catch {
    Write-Host "Decode failed: $_"
    exit 1
}

$hwid = (Get-CimInstance -Class Win32_ComputerSystemProduct).UUID
try {
    $blacklistData = (Invoke-WebRequest -Uri $blacklistLink -UseBasicParsing -ErrorAction Stop).Content
} catch {
    Write-Host "Failed to fetch blacklist: $_"
    exit 1
}
if ($blacklistData -match $hwid) {
    Show-Notification "Blocked" "You are blacklisted from the quiz!" 10
    exit 0
}

try {
    $statusData = (Invoke-WebRequest -Uri $statusLink -UseBasicParsing -ErrorAction Stop).Content.Trim().ToLower()
} catch {
    Write-Host "Failed to fetch status: $_"
    exit 1
}
if ($statusData -eq "true") {
    Write-Host "Exam already completed."
    exit 0
}

$desktopName = $env:COMPUTERNAME
$winVer = (Get-CimInstance -Class Win32_OperatingSystem).Caption
$cpuName = (Get-CimInstance -Class Win32_Processor).Name
$edgeVer = (Get-Item "C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe" -ErrorAction SilentlyContinue).VersionInfo.ProductVersion
if (-not $edgeVer) {
    $edgeVer = (Get-Item "C:\Program Files\Microsoft\Edge\Application\msedge.exe" -ErrorAction SilentlyContinue).VersionInfo.ProductVersion
}
if (-not $edgeVer) { $edgeVer = "Unknown" }
$startTime = Get-Date -Format "HH:mm:ss | dd/MM/yyyy"

$embedBody = @{
    embeds = @(
        @{
            title = "User has started quizz session!"
            color = 3066993
            fields = @(
                @{ name = "Desktop Name"; value = $desktopName; inline = $true }
                @{ name = "HWID"; value = $hwid; inline = $true }
                @{ name = "Windows Version"; value = $winVer; inline = $false }
                @{ name = "CPU"; value = $cpuName; inline = $false }
                @{ name = "Edge Version"; value = $edgeVer; inline = $true }
                @{ name = "Session Start"; value = $startTime; inline = $true }
            )
        }
    )
} | ConvertTo-Json -Depth 10

try {
    Invoke-RestMethod -Uri $webhookLink -Method Post -ContentType "application/json" -Body $embedBody -ErrorAction Stop | Out-Null
} catch {
    Write-Host "Webhook send failed: $_"
}

$browsersToKill = @("chrome", "brave", "opera", "firefox")
foreach ($b in $browsersToKill) {
    Get-Process -Name $b -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
}

Stop-Process -Name "explorer" -Force -ErrorAction SilentlyContinue

Start-Process "msedge.exe" "--kiosk `"$quizLink`" --edge-kiosk-type=fullscreen --no-first-run"

Start-Sleep -Seconds 3

$signature = @"
using System;
using System.Runtime.InteropServices;
public class KeyBlock {
    [DllImport("user32.dll")]
    public static extern bool RegisterHotKey(IntPtr hWnd, int id, uint fsModifiers, uint vk);
    [DllImport("user32.dll")]
    public static extern bool UnregisterHotKey(IntPtr hWnd, int id);
    [DllImport("user32.dll")]
    public static extern IntPtr GetForegroundWindow();
    [DllImport("user32.dll", SetLastError=true)]
    public static extern uint GetWindowThreadProcessId(IntPtr hWnd, out uint processId);
    [DllImport("user32.dll")]
    public static extern bool SetForegroundWindow(IntPtr hWnd);

    private const uint MOD_ALT = 0x0001;
    private const uint MOD_CONTROL = 0x0002;
    private const uint MOD_WIN = 0x0008;
    private const uint MOD_NOREPEAT = 0x4000;

    public static void BlockKeys() {
        RegisterHotKey(IntPtr.Zero, 1, MOD_ALT, 0x09);
        RegisterHotKey(IntPtr.Zero, 2, MOD_ALT | MOD_CONTROL, 0x09);
        RegisterHotKey(IntPtr.Zero, 3, MOD_WIN, 0x44);
        RegisterHotKey(IntPtr.Zero, 4, MOD_WIN, 0x09);
        RegisterHotKey(IntPtr.Zero, 5, MOD_ALT, 0x73);
        RegisterHotKey(IntPtr.Zero, 6, MOD_CONTROL, 0x1B);
        RegisterHotKey(IntPtr.Zero, 7, MOD_WIN, 0x45);
        RegisterHotKey(IntPtr.Zero, 8, MOD_WIN, 0x52);
        RegisterHotKey(IntPtr.Zero, 9, MOD_ALT, 0x1B);
        RegisterHotKey(IntPtr.Zero, 10, MOD_WIN, 0x4C);
        RegisterHotKey(IntPtr.Zero, 11, 0, 0x2C);
        RegisterHotKey(IntPtr.Zero, 12, MOD_WIN, 0x2C);
        RegisterHotKey(IntPtr.Zero, 13, MOD_ALT, 0x2C);
    }

    public static void UnblockKeys() {
        for (int i = 1; i <= 13; i++) {
            UnregisterHotKey(IntPtr.Zero, i);
        }
    }
}
"@

try {
    Add-Type -TypeDefinition $signature -ErrorAction Stop
} catch {
    if ($_.Exception.Message -notmatch "already exists") { throw }
}

[KeyBlock]::BlockKeys()

$global:running = $true
$condition = "ongoing"

$statusJob = Start-Job -ScriptBlock {
    param($url)
    while ($true) {
        try {
            $resp = (Invoke-WebRequest -Uri $url -UseBasicParsing -ErrorAction Stop).Content.Trim().ToLower()
            if ($resp -eq "true") {
                return "completed"
            }
        } catch {}
        Start-Sleep -Seconds 20
    }
} -ArgumentList $statusLink

while ($global:running) {
    if ($statusJob.State -eq "Completed") {
        $condition = Receive-Job -Job $statusJob
        if ($condition -eq "completed") {
            $global:running = $false
            break
        }
    }

    $fgWnd = [KeyBlock]::GetForegroundWindow()
    $procId = 0
    [KeyBlock]::GetWindowThreadProcessId($fgWnd, [ref]$procId) | Out-Null
    $fgProc = $null
    try { $fgProc = Get-Process -Id $procId -ErrorAction Stop } catch {}

    if ($fgProc -and $fgProc.ProcessName -ne "msedge") {
        $condition = "violation"
        $violationBody = @{
            embeds = @(
                @{
                    title = "User possibly cheated"
                    color = 15158332
                    fields = @(
                        @{ name = "Desktop Name"; value = $desktopName; inline = $true }
                        @{ name = "HWID"; value = $hwid; inline = $true }
                        @{ name = "Foreground App"; value = $fgProc.ProcessName; inline = $false }
                        @{ name = "Time"; value = (Get-Date -Format "HH:mm:ss | dd/MM/yyyy"); inline = $false }
                    )
                }
            )
        } | ConvertTo-Json -Depth 10
        try {
            Invoke-RestMethod -Uri $webhookLink -Method Post -ContentType "application/json" -Body $violationBody -ErrorAction Stop | Out-Null
        } catch {}

        Start-Job -ScriptBlock {
            Add-Type -AssemblyName System.Windows.Forms
            $b = New-Object System.Windows.Forms.NotifyIcon
            $b.Icon = [System.Drawing.SystemIcons]::Warning
            $b.BalloonTipTitle = "Warning!"
            $b.BalloonTipText = "Do not close quizz until instructed or it automatically closes!"
            $b.Visible = $true
            $b.ShowBalloonTip(15000)
            Start-Sleep -Seconds 15
            $b.Dispose()
        } | Out-Null

        $edgeProc = Get-Process -Name "msedge" -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($edgeProc) {
            [KeyBlock]::SetForegroundWindow($edgeProc.MainWindowHandle) | Out-Null
        }
        $condition = "ongoing"
    }

    Start-Sleep -Milliseconds 500
}

[KeyBlock]::UnblockKeys()

Get-Process -Name "msedge" -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue

Start-Process "explorer.exe"

Stop-Job -Job $statusJob -ErrorAction SilentlyContinue
Remove-Job -Job $statusJob -Force -ErrorAction SilentlyContinue

Get-Job | Where-Object { $_.State -ne "Running" } | Remove-Job -Force -ErrorAction SilentlyContinue

Write-Host "Exam session completed."
